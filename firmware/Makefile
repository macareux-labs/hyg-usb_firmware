#
# MakeFile for Building HYG-USB Firmware
#
# Usage:
#   if you are using the default MPLAB/XC installation path
#   you can specify your XC/MDB version using XC_VER and MDB_VER variables:
#   $ make XC_VER=v2.60 MDB_VER=v5.50
#
#   if not then you'll need to set CC and MDB (for pickit3 flashing) to the full path of the tools.

# Overridable defaults:

XC_VER ?= v1.37
MDB_VER ?= v5.40
CC  =  /opt/microchip/xc8/${XC_VER}/bin/xc8
MDB = /opt/microchip/mplabx/${MDB_VER}/mplab_platform/bin/mdb.sh

PK2CMD ?= /usr/local/bin/pk2cmd
PK2DEVPATH ?= /usr/share/pk2

CHIP ?= 16F1455

CFLAGS ?= -DENABLE_CRC

# End overridable defaults.

## Internal variables
EXEC = hygusb-firm.hex

# Mandatory arguments:
LDFLAGS := $(LDFLAGS) --chip=$(CHIP)
CFLAGS  := $(CFLAGS) --chip=$(CHIP)

SOURCES = main.c usb.c leds.c i2c.c si7021A10.c
OBJS = $(SOURCES:.c=.p1)

# Build targets

all: $(EXEC)
.PHONY: all clean pickit3 pickit2

clean:
	rm -f MPLABXLog.xml*
	rm -f l.obj
	rm -f funclist
	rm -f prog.cmd
	rm -f $(EXEC:.hex=.*)
	rm -f startup.*
	rm -f *.d *.i *.p1 *.pre

pickit3: $(EXEC)
	rm -f prog.cmd
	echo "Device PIC$(CHIP)" >> prog.cmd
	echo "Hwtool PICkit3 -p" >> prog.cmd
	echo "Program $(EXEC)" >> prog.cmd
	echo "Quit" >> prog.cmd
	$(MDB) prog.cmd
	@rm -f prog.cmd

pickit2: $(EXEC)
	$(PK2CMD) -M -PPIC${CHIP} -F$(EXEC) -B$(PK2DEVPATH)

$(EXEC): $(OBJS)
	$(CC) $(LDFLAGS) $^ -O$@

# Pre-compile and generate dependency informations
# Fix .d files generated by xc8 to be compatible with GNU Make
# Generate empty target for each depency to handle renamming/removing dependencies
#  see http://scottmcpeak.com/autodepend/autodepend.html
%.p1: %.c
	$(CC) --pass1 $(CFLAGS) $<
	@sed -i "s/^.\+\.d[[:space:]]\+//" $*.d
	@sed -e 's/.*://; s/\\$$//' $*.d | fmt -1 | \
	  sed -e 's/^ */\n/;s/$$/:/' >> $*.d

-include $(SOURCES:.c=.d)
